import pandas as pd
from app.data.db import connect_database


# storing dataset metadata into the database
def insert_dataset_metadata(name, group, src, updated_on, rows_count, size_mb):
    """
    Inserts a single metadata record into the datasets_metadata table.
    Returns the autogenerated row ID.
    """
    db = connect_database()
    cur = db.cursor()

    cur.execute(
        """
        INSERT INTO datasets_metadata
        (dataset_name, category, source, last_updated, record_count, file_size_mb)
        VALUES (?, ?, ?, ?, ?, ?)
        """,
        (name, group, src, updated_on, rows_count, size_mb)
    )

    db.commit()
    meta_id = cur.lastrowid
    db.close()
    return meta_id


# loading a CSV file into a database table
def load_csv_to_table(csv_path, table, mode="append"):
    """
    Reads a CSV using pandas and loads it into a table via to_sql().
    mode = 'append' or 'replace'
    Returns the number of rows inserted.
    """
    db = connect_database()
    frame = pd.read_csv(csv_path)

    frame.to_sql(
        name=table,
        con=db,
        if_exists=mode,
        index=False
    )

    db.close()
    return len(frame)
